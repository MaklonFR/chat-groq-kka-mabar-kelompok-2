<!DOCTYPE html>
<html lang="id" class="dark">
<head>
  <meta charset="UTF-8" />
  <title>Chatbot MaklonFR</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/react@17/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            primary: '#dc2626',
            secondary: '#b91c1c',
          },
        },
      },
    };
  </script>

  <style>
    body {
      background: linear-gradient(135deg, #fff0f0, #ffdddd, #ffffff);
    }

    .dark body {
      background: linear-gradient(135deg, #1f1f1f, #2e2e2e, #1f1f1f);
    }

    .chat-bubble {
      transform: perspective(1000px) rotateX(1deg);
    }
  </style>
</head>
<body class="min-h-screen transition-colors duration-700">

  <!-- Theme Toggle -->
  <div class="flex justify-end p-4">
    <button id="theme-toggle" class="px-3 py-2 bg-white/30 dark:bg-black/30 rounded-lg text-sm backdrop-blur-md hover:bg-white/50 dark:hover:bg-black/50 transition text-gray-900 dark:text-white">
      🌙
    </button>
  </div>

  <!-- React Root -->
  <div id="root" class="p-4"></div>

  <!-- React App -->
  <script type="text/babel">
    const { useState, useEffect, useRef } = React;

    const ChatApp = () => {
      const [message, setMessage] = useState("");
      const [history, setHistory] = useState([]);
      const [isLoading, setIsLoading] = useState(false);
      const chatContainerRef = useRef(null);

      const sendMessage = async () => {
        if (!message.trim()) return;

        const newHistory = [...history, { role: "user", content: message }];
        setHistory(newHistory);
        setMessage("");
        setIsLoading(true);

        try {
          const response = await axios.post("https://maklonfr.pythonanywhere.com/chat", {
            message,
            history,
          });
          const { reply, history: updatedHistory } = response.data;
          setHistory([...newHistory, { role: "assistant", content: reply }]);
        } catch (error) {
          setHistory([...newHistory, { role: "assistant", content: "❌ Gagal menghubungi server." }]);
        } finally {
          setIsLoading(false);
        }
      };

      const handleKeyPress = (e) => {
        if (e.key === "Enter" && !e.shiftKey) {
          e.preventDefault();
          sendMessage();
        }
      };

      useEffect(() => {
        if (chatContainerRef.current) {
          chatContainerRef.current.scrollTop = chatContainerRef.current.scrollHeight;
        }
      }, [history]);

      return (
        <div className="w-full max-w-3xl mx-auto">
          <h1 className="text-3xl font-bold text-center mb-6 text-primary dark:text-white drop-shadow-lg">💬 Chatbot MaklonFR</h1>

          <div ref={chatContainerRef} className="bg-white/70 dark:bg-gray-800/70 rounded-xl shadow-2xl p-6 h-[70vh] overflow-y-auto mb-6 border dark:border-gray-600 border-gray-200 transition-all">
            {history.length === 0 ? (
              <div className="text-center text-gray-500 dark:text-gray-400 mt-10">
                Ketik pesan untuk memulai percakapan.
              </div>
            ) : (
              history.map((msg, idx) => (
                <div key={idx} className={`mb-4 flex items-start ${msg.role === "user" ? "justify-end" : "justify-start"}`}>
                  {msg.role === "assistant" && (
                    <div className="mr-2 text-2xl">🤖</div>
                  )}
                  <div className={`chat-bubble max-w-[80%] p-4 rounded-2xl shadow-md transition-all ${
                    msg.role === "user"
                      ? "bg-primary text-white ml-2"
                      : "bg-gray-200 dark:bg-gray-700 text-gray-900 dark:text-white mr-2"
                  }`}>
                    <div className="text-xs opacity-60 mb-1 font-medium">
                      {msg.role === "user" ? "👤 Anda" : "🤖 Asisten"}
                    </div>
                    {msg.content}
                  </div>
                  {msg.role === "user" && (
                    <div className="ml-2 text-2xl">👤</div>
                  )}
                </div>
              ))
            )}
          </div>

          <div className="flex gap-2 mb-6">
            <textarea
              value={message}
              onChange={(e) => setMessage(e.target.value)}
              onKeyPress={handleKeyPress}
              placeholder="Ketik pesan Anda..."
              className="flex-1 p-3 bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary resize-none h-16 text-gray-900 dark:text-white shadow-md"
              disabled={isLoading}
            />
            <button
              onClick={sendMessage}
              disabled={isLoading || !message.trim()}
              className={`px-4 py-2 bg-primary text-white rounded-lg hover:bg-secondary transition-all shadow-lg ${
                isLoading || !message.trim() ? "opacity-50 cursor-not-allowed" : ""
              }`}
            >
              {isLoading ? (
                <svg
                  className="animate-spin h-5 w-5 text-white"
                  xmlns="http://www.w3.org/2000/svg"
                  fill="none"
                  viewBox="0 0 24 24"
                >
                  <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                  <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v8H4z"></path>
                </svg>
              ) : (
                "Kirim"
              )}
            </button>
          </div>

          <footer className="text-center text-sm text-gray-500 dark:text-gray-400 border-t border-gray-300 dark:border-gray-700 pt-4">
            &copy; 2025 MaklonFR Chatbot. All rights reserved.
          </footer>
        </div>
      );
    };

    ReactDOM.render(<ChatApp />, document.getElementById("root"));
  </script>

  <!-- Theme Toggle Script -->
  <script>
    const themeToggle = document.getElementById('theme-toggle');
    themeToggle.addEventListener('click', () => {
      document.documentElement.classList.toggle('dark');
      themeToggle.textContent = document.documentElement.classList.contains('dark') ? '🌞' : '🌙';
    });
  </script>
</body>
</html>
